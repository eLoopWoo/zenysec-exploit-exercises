#!/usr/bin/env bash

function welcome(){
        echo "** ZenySec Exercises **"

        if [[ $EUID -ne 0 ]]; then
                echo "This script must be run as root"
                exit 1
        fi

        if [ -z "$1" ]; then
                echo "usage: ./setup.sh user_name"
		        exit 1
        fi
}

function download_arm_binutils(){
        echo "[*] Downloading arm-binutils..."
        if ! grep -q pwntools /etc/apt/sources.list ; then
            echo "deb http://ppa.launchpad.net/pwntools/binutils/ubuntu trusty bionic main" >> /etc/apt/sources.list
        fi
        apt -o Acquire::AllowInsecureRepositories=true -o Acquire::AllowDowngradeToInsecureRepositories=true update
        apt-get install binutils-arm-linux-gnu
}

function download_gdb_multi_arch(){
        echo "[*] Downloading gdb-multiarch..."
        apt-get install -y gdb-multiarch
}

function download_qemu(){
        echo "[*] Downloading QEMU..."
        apt-get install -y qemu
        apt-get install -y qemu-user-static
}

function download_kpartx(){
        echo "[*] Downloading kpatx..."
        apt-get install -y kpartx
}

function download_kpartx(){
        echo "[*] Downloading sshpass..."
        apt-get install -y sshpass
}

function download_tools(){
        echo "[*] Downloading tools..."
        sshpass -p 'welcome' scp -P20000 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no welcome@exercises-arm32v7.zenysec.com:/home/welcome/\{debug.sh,gdb_plugin.sh,run.sh,remote.sh\} .
}

function download_challenges(){
        echo "[*] Downloading challenges..."

	for i in ch00 ch01 ch02 ch03 ch04 ch05 ch06 ch07 ch08 ch09 ch10 ch11 ch12; do
		mkdir -p $i
        	sshpass -p $i scp -P20000 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no $i@exercises-arm32v7.zenysec.com:/home/$i/\{$i.c,$i,compile.sh\} $i/
	done
}

function download(){
    apt-get update

    download_qemu
    download_kpartx
    download_gdb_multi_arch
    download_tools
    download_challenges
    download_arm_binutils

}

function change_permissions(){
    chgrp -R $1 ch*/
    chown -R $1 ch*/
    chmod 777 ch*/*

    chgrp -R $1 *.sh
    chown -R $1 *.sh
    chmod +x *.sh
}

function main(){
        welcome $1
        download $1
        change_permissions $1
}

main $1
echo "[*] Done!"
