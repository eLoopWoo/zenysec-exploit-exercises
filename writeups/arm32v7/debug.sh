#!/usr/bin/env bash

function welcome(){
        echo "** ZenySec Exercises **"

        if [ -z $1 ] || [ -z $2 ] ; then
                echo "usage: ./debug.sh arm-executable port"
		exit 1
        fi
}

function run_gdb_server(){
        echo "[*] Killing running gdb-server..."
        kill -9 `ps -A | grep qemu-arm-static | cut -d' ' -f1`

        echo "[*] Executing gdb-server for $1 on port $2..."
        #x-terminal-emulator -e "qemu-arm-static -g $2 $1"
        gnome-terminal -e "qemu-arm-static -g $2 $1"
}

function run_gdb_attach(){
        echo "[*] Executing gdb-multiarch for $1 on port $2..."
        echo "[*] Use xhelp in gdb for help..."
        sed -i "s/localhost:[0-9]*/localhost:$2/g" gdb_plugin.sh
        gdb-multiarch $1 -x gdb_plugin.sh
}


function main(){
        welcome $1 $2
        run_gdb_server $1 $2
        run_gdb_attach $1 $2
}

main $1 $2
echo "[*] Done!"
